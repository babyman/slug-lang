%YAML 1.2
---
# Sublime Text syntax definition for the Slug programming language
# See http://www.sublimetext.com/docs/syntax.html
#
# Slug is a simple, interpreted language with a syntax inspired by JavaScript and Go.
# Features include:
# - First-class functions
# - Dynamic typing
# - List and map data structures
# - Powerful pattern matching
# - Method chaining
# - Default parameter values
# - Variadic arguments
# - Error handling with throw/defer
# - Bitwise operations
# - Annotations via @tag syntax
#
# For more information, see: https://github.com/babyman/slug
#
name: Slug
file_extensions:
  - slug
first_line_match: '^#!.*\bslug\b'
scope: source.slug

contexts:
  main:
    # Comments
    - match: /\*\*
      scope: comment.block.documentation.slug
      push: doc_comment_block
    - match: /\*
      scope: comment.block.slug
      push: comment_block
    - match: //.*$
      scope: comment.line.double-slash.slug
    - match: \#.*$
      scope: comment.line.number-sign.slug

    # Symbols
    - match: :(?:nil|true|false)\b
      scope: constant.language.symbol.slug
    - match: :(?:bool|number|string|list|map|bytes|function|task|struct|symbol|error)\b
      scope: support.type.symbol.slug
    - match: :[a-zA-Z_][a-zA-Z0-9_]*
      scope: constant.other.symbol.slug
    - match: :"""
      scope: constant.other.symbol.slug
      push: symbol_triple_double
    - match: :'''
      scope: constant.other.symbol.slug
      push: symbol_triple_single
    - match: :"
      scope: constant.other.symbol.slug
      push: symbol_double
    - match: :'
      scope: constant.other.symbol.slug
      push: symbol_single

    # Annotations/Tags
    - match: (@export)\b
      scope: storage.modifier.slug
    - match: (@testWith)\b
      scope: meta.annotation.test.slug
    - match: (@(?:bool|bytes|fn|list|map|num|str|symbol|task))\b
      scope: storage.type.annotation.slug
    - match: (@[a-zA-Z][a-zA-Z0-9_]*)
      scope: entity.name.tag.slug
      push: annotation_args

    # Include destructuring patterns
    - match: \b(var|val)\s+(\[|\{)
      captures:
        1: storage.type.slug
      push: destructuring_pattern

    # Keywords
    - match: \b(var|val)\b
      scope: storage.type.slug

    - match: \b(true|false)\b
      scope: constant.language.boolean.slug
    - match: \b(nil)\b
      scope: constant.language.nil.slug

    - match: \b(fn|foreign|match|struct|copy)\b
      scope: keyword.control.slug
    - match: \b(if)\b
      scope: keyword.control.conditional.if.slug
    - match: \b(else)\b
      scope: keyword.control.conditional.else.slug
    - match: \b(recur)\b
      scope: keyword.control.flow.slug
    - match: \b(return)\b
      scope: keyword.control.flow.return.slug
    - match: \b(throw)\b
      scope: keyword.control.flow.throw.slug
    - match: \b(defer|onsuccess|onerror)\b
      scope: keyword.control.flow.defer.slug

    - match: \b(nursery|limit|spawn|await|within)\b
      scope: keyword.control.concurrent.slug

    # Built-in functions
    - match: \b(len|import|print|println|stacktrace|argv|argm|cfg)\b
      scope: support.function.builtin.slug
    - match: \b(type|keys|sym|label)\b
      scope: support.function.stdlib.slug

    # Function calls
    - match: \b([a-zA-Z_][a-zA-Z0-9_]*)\s*\(
      captures:
        1: variable.function.slug

    # Identifiers (variables, properties, etc.)
    - match: \b[a-zA-Z_][a-zA-Z0-9_]*\b
      scope: variable.other.slug

    # Operators
    - match: (/>|=>|\.\.\.|\?\?\?|:\+|\+:)
      scope: keyword.operator.slug
    - match: (\{\|)
      scope: punctuation.section.braces.begin.slug
    - match: (\|\})
      scope: punctuation.section.braces.end.slug
    - match: (\.)
      scope: punctuation.accessor.dot.slug
    - match: (==|!=|<|>|<=|>=)
      scope: keyword.operator.comparison.slug
    - match: (!|&&|\|\|)
      scope: keyword.operator.logical.slug
    - match: (<<|>>|&|\||\^|~)
      scope: keyword.operator.bitwise.slug
    - match: =
      scope: keyword.operator.assignment.slug
    - match: (\+|-|\*|/|%)
      scope: keyword.operator.arithmetic.slug

    # Hex numbers (even number of hex digits)
    - match: \b0x(?:_?[0-9a-fA-F]{2})+\b
      scope: constant.numeric.hex.slug

    # Byte array literals 0x"...." with even number of hex digits
    - match: \b0x"\s*(?:[0-9a-fA-F]{2})*\s*"
      scope: constant.numeric.byte-array.hex.slug

    # Raw Strings (Single Quotes)
    - match: "'''"
      scope: punctuation.definition.string.begin.slug
      push: raw_string_multi
    - match: "'"
      scope: punctuation.definition.string.begin.slug
      push: raw_string_single

    # Interpreted Strings (Double Quotes)
    - match: '"""'
      scope: punctuation.definition.string.begin.slug
      push: string_multi
    - match: '"'
      scope: punctuation.definition.string.begin.slug
      push: string

    # Numbers
    - match: \b\d(?:[\d_]*\d)?(?:\.\d(?:[\d_]*\d)?)?[eE][+-]?\d(?:[\d_]*\d)?\b
      scope: constant.numeric.float.slug
    - match: \b\d(?:[\d_]*\d)?\.\d(?:[\d_]*\d)?\b
      scope: constant.numeric.float.slug
    - match: \b\d(?:[\d_]*\d)?\b
      scope: constant.numeric.integer.slug

    # Lists
    - match: \[
      scope: punctuation.section.brackets.begin.slug
      push: list
    - match: \]
      scope: punctuation.section.brackets.end.slug

    # Function definition
    - match: \b(fn)\s*\(
      captures:
        1: keyword.control.slug
      push: function_params

    # Match expression
    - match: \bmatch\b
      scope: keyword.control.slug
      push: match_after_keyword

    # Delimiters
    - match: \(
      scope: punctuation.section.parens.begin.slug
      push: parens
    - match: \)
      scope: punctuation.section.parens.end.slug
    - match: \{
      scope: punctuation.section.braces.begin.slug
      push: braces
    - match: \}
      scope: punctuation.section.braces.end.slug
    - match: ;
      scope: punctuation.terminator.statement.slug
    - match: ':'
      scope: punctuation.separator.colon.slug
    - match: ','
      scope: punctuation.separator.comma.slug


  string:
    - meta_scope: string.quoted.double.slug
    - match: '"'
      scope: punctuation.definition.string.end.slug
      pop: true
    - match: \\[\\'"nrt\{]
      scope: constant.character.escape.slug
    - match: \\[0-7]{1,3}
      scope: constant.character.escape.slug
    - match: "{{"
      scope: punctuation.section.braces.begin.slug
      push: interpolation
    - match: .
      scope: string.quoted.double.slug

  string_multi:
    - meta_scope: string.quoted.double.multi.slug
    - match: '"""'
      scope: punctuation.definition.string.end.slug
      pop: true
    - match: \\[\\'"nrt\{]
      scope: constant.character.escape.slug
    - match: \\[0-7]{1,3}
      scope: constant.character.escape.slug
    - match: "{{"
      scope: punctuation.section.braces.begin.slug
      push: interpolation
    - match: .
      scope: string.quoted.double.multi.slug

  interpolation:
    - meta_scope: meta.interpolation.slug
    - match: "}}"
      scope: punctuation.section.braces.end.slug
      pop: true
    - include: main

  raw_string_single:
    - meta_scope: string.quoted.single.raw.slug
    - match: "'"
      scope: punctuation.definition.string.end.slug
      pop: true
    - match: .
      scope: string.quoted.single.raw.slug

  raw_string_multi:
    - meta_scope: string.quoted.single.multi.raw.slug
    - match: "'''"
      scope: punctuation.definition.string.end.slug
      pop: true
    - match: .
      scope: string.quoted.single.multi.raw.slug

  list:
    - meta_scope: meta.structure.list.slug
    - match: \]
      scope: punctuation.section.brackets.end.slug
      pop: true
    - include: main

  parens:
    - meta_scope: meta.group.slug
    - match: \)
      scope: punctuation.section.parens.end.slug
      pop: true
    - include: main

  doc_comment_block:
    - meta_scope: comment.block.documentation.slug
    - match: \*/
      pop: true
    - match: .

  comment_block:
    - meta_scope: comment.block.slug
    - match: \*/
      pop: true
    - match: .

  destructuring_pattern:
    - meta_scope: meta.destructuring.slug
    - match: \]|\}|\|\}
      scope: punctuation.section.end.slug
      pop: true
    - match: ':'
      scope: punctuation.separator.destructuring.slug
    - match: \.\.\.
      scope: keyword.operator.spread.slug
    - match: \{\|
      scope: punctuation.section.braces.begin.slug
    - match: _
      scope: constant.language.underscore.slug
    - include: main

  braces:
    - meta_scope: meta.block.slug
    - match: \}|\|\}
      scope: punctuation.section.braces.end.slug
      pop: true
    - match: \{\|
      scope: punctuation.section.braces.begin.slug
    - include: main

  function_params:
    - meta_scope: meta.function.parameters.slug
    - match: \)
      scope: punctuation.section.parens.end.slug
      pop: true
    - match: \b[a-zA-Z_][a-zA-Z0-9_]*\b
      scope: variable.parameter.slug
    - match: =
      scope: keyword.operator.assignment.slug
    - match: \.\.\.
      scope: keyword.operator.variadic.slug
    - match: ':'
      scope: punctuation.separator.parameter.slug
    - include: main

  pattern_matching:
    - meta_scope: meta.pattern-matching.slug
    - match: \]|\}
      pop: true
    - match: _
      scope: constant.language.underscore.slug
    - match: \.\.\.
      scope: keyword.operator.variadic.slug
    - match: \{\|
      scope: punctuation.section.braces.begin.slug
    - match: \|\}
      scope: punctuation.section.braces.end.slug
    - match: ','
      scope: punctuation.separator.comma.slug
    - match: ':'
      scope: punctuation.separator.key-value.slug
    - include: main

  match_expression:
    - meta_scope: meta.match.slug
    - match: \}|\|\}
      scope: punctuation.section.braces.end.slug
      pop: true
    - match: =>
      scope: keyword.operator.arrow.slug
    - match: _
      scope: constant.language.underscore.slug
    - match: \.\.\.
      scope: keyword.operator.variadic.slug
    - match: \{\|
      scope: punctuation.section.braces.begin.slug
    - match: ":"
      scope: punctuation.separator.pattern.slug
    - match: ","
      scope: punctuation.separator.pattern.comma.slug
    - match: \b(if)\b
      scope: keyword.control.conditional.slug
    - include: main

  annotation_args:
    - meta_scope: meta.annotation.slug
    - match: \(
      scope: punctuation.section.parens.begin.slug
      push: annotation_parens
    - match: (?=[^\s])
      pop: true

  match_after_keyword:
    - match: \{\|
      scope: punctuation.section.braces.begin.slug
      set: match_expression
    - match: \{
      scope: punctuation.section.braces.begin.slug
      set: match_expression
    - include: main

  annotation_parens:
    - meta_scope: meta.annotation.arguments.slug
    - match: \)
      scope: punctuation.section.parens.end.slug
      pop: true
    - include: main

  symbol_double:
    - meta_scope: constant.other.symbol.slug
    - match: '"'
      scope: punctuation.definition.string.end.slug
      pop: true
    - match: \\[\\'"nrt\{]
      scope: constant.character.escape.slug
    - match: \\[0-7]{1,3}
      scope: constant.character.escape.slug
    - match: .
      scope: constant.other.symbol.slug

  symbol_single:
    - meta_scope: constant.other.symbol.slug
    - match: "'"
      scope: punctuation.definition.string.end.slug
      pop: true
    - match: .
      scope: constant.other.symbol.slug

  symbol_triple_double:
    - meta_scope: constant.other.symbol.slug
    - match: '"""'
      scope: punctuation.definition.string.end.slug
      pop: true
    - match: \\[\\'"nrt\{]
      scope: constant.character.escape.slug
    - match: \\[0-7]{1,3}
      scope: constant.character.escape.slug
    - match: .
      scope: constant.other.symbol.slug

  symbol_triple_single:
    - meta_scope: constant.other.symbol.slug
    - match: "'''"
      scope: punctuation.definition.string.end.slug
      pop: true
    - match: .
      scope: constant.other.symbol.slug
